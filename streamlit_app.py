import streamlit as st
import requests
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd
import numpy as np

# Configuration avec th√®me color√©
st.set_page_config(
    page_title="Pr√™t √† D√©penser",
    page_icon="üí∞",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS personnalis√©
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
        padding: 1rem;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
    }
    .success-card {
        background: linear-gradient(45deg, #56ab2f 0%, #a8e6cf 100%);
        padding: 1rem;
        border-radius: 10px;
        border-left: 5px solid #28a745;
    }
    .danger-card {
        background: linear-gradient(45deg, #ff6b6b 0%, #feca57 100%);
        padding: 1rem;
        border-radius: 10px;
        border-left: 5px solid #dc3545;
    }
</style>
""", unsafe_allow_html=True)

API_URL = "http://127.0.0.1:8000"

# En-t√™te color√©
st.markdown("""
<div class="main-header">
    <h1>üè¶ Pr√™t √† D√©penser - Syst√®me d'√âvaluation Cr√©dit</h1>
    <p>Plateforme intelligente avec mod√®le LightGBM (Seuil: 9%)</p>
</div>
""", unsafe_allow_html=True)

# Sidebar
st.sidebar.markdown("### üîß Configuration")

# Test API
try:
    response = requests.get(f"{API_URL}/status", timeout=2)
    api_ok = response.status_code == 200
    if api_ok:
        st.sidebar.markdown("üü¢ **API connect√©e**")
        # Afficher infos mod√®le
        try:
            model_info = requests.get(f"{API_URL}/model/info").json()
            st.sidebar.write(f"Mod√®le: {model_info.get('model_type', 'N/A')}")
            st.sidebar.write(f"Seuil: {model_info.get('threshold', 0):.1%}")
        except:
            pass
    else:
        st.sidebar.markdown("üî¥ **API erreur**")
except:
    api_ok = False
    st.sidebar.markdown("üî¥ **API non accessible**")

# Menu
mode = st.sidebar.radio(
    "### üìã Mode d'analyse",
    ["üîç Client Existant", "‚ûï Nouveau Client"],
    format_func=lambda x: x
)

def create_explanation_charts(client_data, prediction_result):
    """Cr√©er des graphiques d'explication pour le banquier"""
    
    prob = prediction_result["prediction"]["probability"]
    age_years = abs(client_data["DAYS_BIRTH"]) // 365
    ratio_credit = client_data["AMT_CREDIT"] / client_data["AMT_GOODS_PRICE"]
    
    # Graphique en secteurs des facteurs de risque
    factors = {
        "Scores Externes": 30 if (client_data.get("EXT_SOURCE_2", 0.5) + client_data.get("EXT_SOURCE_3", 0.5)) > 1.0 else 15,
        "Ratio de Financement": 25 if ratio_credit > 0.9 else 10,
        "Profil √Çge": 20 if age_years < 25 or age_years > 65 else 5,
        "Montant du Cr√©dit": 15 if client_data["AMT_CREDIT"] > 500000 else 8,
        "Historique Paiements": 10 if client_data.get("INST_PAYMENT_PERC_mean", 0.9) < 0.8 else 2
    }
    
    colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff']
    fig_factors = px.pie(
        values=list(factors.values()),
        names=list(factors.keys()),
        title="üéØ R√©partition des Facteurs de Risque",
        color_discrete_sequence=colors
    )
    fig_factors.update_traces(textposition='inside', textinfo='percent+label')
    
    # Graphique comparatif
    comparison_data = pd.DataFrame({
        'Crit√®re': ['Score Externe Moyen', 'Ratio Financement', '√Çge', 'Capacit√© Remboursement'],
        'Client': [
            (client_data.get("EXT_SOURCE_2", 0.5) + client_data.get("EXT_SOURCE_3", 0.5)) / 2,
            min(ratio_credit, 1.0),
            min(age_years / 70, 1.0),
            min(client_data["AMT_ANNUITY"] / (client_data["AMT_CREDIT"] * 0.05), 1.0)
        ],
        'Seuil Acceptable': [0.6, 0.8, 0.7, 0.8]
    })
    
    fig_comparison = px.bar(
        comparison_data,
        x='Crit√®re',
        y=['Client', 'Seuil Acceptable'],
        title="üìä Comparaison avec les Seuils Standards",
        barmode='group',
        color_discrete_sequence=['#667eea', '#f093fb']
    )
    
    # Timeline simulation
    months = list(range(1, 37))
    monthly_payment = client_data["AMT_ANNUITY"]
    remaining_balance = [client_data["AMT_CREDIT"] - (i * monthly_payment) for i in months]
    risk_evolution = [prob * (1 + 0.1 * np.sin(i/6)) for i in months]
    
    fig_timeline = go.Figure()
    fig_timeline.add_trace(go.Scatter(
        x=months, y=remaining_balance,
        mode='lines+markers',
        name='Solde Restant (‚Ç¨)',
        line=dict(color='#48dbfb', width=3),
        yaxis='y'
    ))
    
    fig_timeline.add_trace(go.Scatter(
        x=months, y=risk_evolution,
        mode='lines+markers',
        name='√âvolution du Risque (%)',
        line=dict(color='#ff6b6b', width=3),
        yaxis='y2'
    ))
    
    fig_timeline.update_layout(
        title="üìà Simulation d'√âvolution du Cr√©dit sur 3 ans",
        xaxis_title="Mois",
        yaxis=dict(title="Solde Restant (‚Ç¨)", side="left"),
        yaxis2=dict(title="Niveau de Risque", side="right", overlaying="y"),
        hovermode='x unified'
    )
    
    return fig_factors, fig_comparison, fig_timeline

def display_banker_explanation(client_data, result, client_id=None):
    """Affichage d√©taill√© pour explication banquier-client"""
    
    prediction = result["prediction"]
    prob = prediction["probability"]
    decision = prediction["decision"]
    
    # En-t√™te de r√©sultat avec couleurs
    if "FIABLE" in decision:
        st.markdown(f"""
        <div class="success-card">
            <h2>‚úÖ CR√âDIT ACCORD√â</h2>
            <p><strong>Risque √©valu√©:</strong> {prob:.1%} (Seuil: 9%)</p>
            {"<p><strong>Client ID:</strong> " + str(client_id) + "</p>" if client_id else ""}
        </div>
        """, unsafe_allow_html=True)
    else:
        st.markdown(f"""
        <div class="danger-card">
            <h2>‚ùå CR√âDIT REFUS√â</h2>
            <p><strong>Risque √©valu√©:</strong> {prob:.1%} (Seuil d√©pass√©: 9%)</p>
            {"<p><strong>Client ID:</strong> " + str(client_id) + "</p>" if client_id else ""}
        </div>
        """, unsafe_allow_html=True)
    
    # M√©triques principales
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        age_years = abs(client_data["DAYS_BIRTH"]) // 365
        st.metric("üë§ √Çge", f"{age_years} ans")
    
    with col2:
        ratio = client_data["AMT_CREDIT"] / client_data["AMT_GOODS_PRICE"]
        st.metric("üí∞ Taux Financement", f"{ratio:.1%}")
    
    with col3:
        monthly_income_est = client_data["AMT_CREDIT"] / 60
        st.metric("üìä Effort Mensuel", f"{client_data['AMT_ANNUITY'] / monthly_income_est:.1%}")
    
    with col4:
        ext_avg = (client_data.get("EXT_SOURCE_1", 0.5) + client_data.get("EXT_SOURCE_2", 0.5) + client_data.get("EXT_SOURCE_3", 0.5)) / 3
        st.metric("‚≠ê Score Moyen", f"{ext_avg:.2f}/1.0")
    
    # Jauge principale avec seuil 9%
    fig_gauge = go.Figure(go.Indicator(
        mode="gauge+number",
        value=prob * 100,
        title={'text': "üéØ Niveau de Risque de D√©faut", 'font': {'size': 20}},
        gauge={
            'axis': {'range': [None, 100], 'tickwidth': 1, 'tickcolor': "darkblue"},
            'bar': {'color': "darkblue"},
            'bgcolor': "white",
            'borderwidth': 2,
            'bordercolor': "gray",
            'steps': [
                {'range': [0, 9], 'color': '#a8e6cf'},
                {'range': [9, 30], 'color': '#ffd93d'},
                {'range': [30, 50], 'color': '#ff8b94'},
                {'range': [50, 100], 'color': '#ff6b6b'}
            ],
            'threshold': {
                'line': {'color': "red", 'width': 4},
                'thickness': 0.75,
                'value': 9
            }
        }
    ))
    
    fig_gauge.update_layout(height=400, font={'color': "darkblue", 'family': "Arial"})
    st.plotly_chart(fig_gauge, use_container_width=True)
    
    # Graphiques d'explication
    st.markdown("### üìã Analyse D√©taill√©e pour Discussion Client")
    
    fig_factors, fig_comparison, fig_timeline = create_explanation_charts(client_data, result)
    
    col1, col2 = st.columns(2)
    with col1:
        st.plotly_chart(fig_factors, use_container_width=True)
    with col2:
        st.plotly_chart(fig_comparison, use_container_width=True)
    
    st.plotly_chart(fig_timeline, use_container_width=True)
    
    # Arguments pour le banquier
    st.markdown("### üí¨ Arguments pour Discussion avec le Client")
    
    if "FIABLE" in decision:
        st.success(f"""
        **Points Positifs √† Mentionner:**
        - Votre profil pr√©sente un risque faible de {prob:.1%}
        - Vos scores externes sont satisfaisants
        - Votre capacit√© de remboursement est adapt√©e
        - Le ratio de financement reste raisonnable √† {client_data["AMT_CREDIT"] / client_data["AMT_GOODS_PRICE"]:.1%}
        
        **Conditions Propos√©es:**
        - Montant accord√©: {client_data["AMT_CREDIT"]:,} ‚Ç¨
        - Mensualit√©: {client_data["AMT_ANNUITY"]:,} ‚Ç¨
        - Dur√©e estim√©e: {client_data["AMT_CREDIT"] // client_data["AMT_ANNUITY"]:.0f} mois
        """)
    else:
        reasons = []
        if prob > 0.09:
            reasons.append("Le score de risque d√©passe le seuil de 9%")
        if client_data["AMT_CREDIT"] / client_data["AMT_GOODS_PRICE"] > 0.9:
            reasons.append("Le taux de financement est trop √©lev√©")
        if ext_avg < 0.4:
            reasons.append("Les scores externes sont insuffisants")
        
        st.error(f"""
        **Raisons du Refus:**
        """ + "\n".join([f"- {reason}" for reason in reasons]) + f"""
        
        **Alternatives √† Proposer:**
        - R√©duire le montant √† {int(client_data["AMT_CREDIT"] * 0.8):,} ‚Ç¨ (risque estim√©: {prob * 0.8:.1%})
        - Augmenter l'apport personnel
        - Proposer un co-emprunteur
        - Revoir la demande dans 6 mois
        """)

# Interface principale
if "üîç Client Existant" in mode:
    st.markdown("## üîç Recherche et Analyse Client")
    
    col1, col2 = st.columns([2, 1])
    with col1:
        client_id = st.number_input("üÜî Num√©ro Client", value=100001, min_value=100000, step=1)
    with col2:
        analyze_btn = st.button("üîç Analyser le Dossier", type="primary", use_container_width=True)
    
    if analyze_btn:
        if not api_ok:
            st.error("üîå API non disponible")
        else:
            with st.spinner("üîÑ Analyse en cours..."):
                # Simulation donn√©es client
                np.random.seed(client_id)
                client_data = {
                    "EXT_SOURCE_2": np.random.uniform(0.2, 0.9),
                    "EXT_SOURCE_3": np.random.uniform(0.2, 0.9),
                    "AMT_GOODS_PRICE": np.random.randint(200000, 800000),
                    "CODE_GENDER": np.random.choice(["M", "F"]),
                    "EXT_SOURCE_1": np.random.uniform(0.2, 0.9),
                    "AMT_ANNUITY": np.random.randint(15000, 50000),
                    "AMT_CREDIT": np.random.randint(250000, 900000),
                    "DAYS_BIRTH": np.random.randint(-25000, -8000),
                    "INST_PAYMENT_PERC_mean": np.random.uniform(0.7, 1.0),
                    "NAME_EDUCATION_TYPE": "Higher education"
                }
                
                try:
                    response = requests.post(f"{API_URL}/predict/demo", json=client_data, timeout=10)
                    if response.status_code == 200:
                        result = response.json()
                        display_banker_explanation(client_data, result, client_id)
                    else:
                        st.error(f"‚ùå Erreur API: {response.status_code}")
                except Exception as e:
                    st.error(f"‚ö†Ô∏è Erreur: {str(e)}")

else:  # Nouveau Client
    st.markdown("## ‚ûï Nouvelle Demande de Cr√©dit")
    
    with st.form("nouveau_client_form"):
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("#### üë§ Informations Personnelles")
            age = st.slider("√Çge", 18, 80, 35)
            gender = st.selectbox("Genre", ["M", "F"])
            education = st.selectbox("Niveau d'√©tudes", [
                "Secondary / secondary special",
                "Higher education",
                "Lower secondary"
            ])
            
            st.markdown("#### üí∞ Demande de Cr√©dit")
            credit_amount = st.number_input("Montant demand√© (‚Ç¨)", value=300000, step=10000)
            goods_price = st.number_input("Prix du bien (‚Ç¨)", value=350000, step=10000)
            annuity = st.number_input("Mensualit√© souhait√©e (‚Ç¨)", value=15000, step=1000)
        
        with col2:
            st.markdown("#### üìä √âvaluations Externes")
            st.info("Scores bureaux de cr√©dit (0=risqu√©, 1=excellent)")
            ext1 = st.slider("Bureau Cr√©dit 1", 0.0, 1.0, 0.6, step=0.01)
            ext2 = st.slider("Bureau Cr√©dit 2", 0.0, 1.0, 0.6, step=0.01)
            ext3 = st.slider("Bureau Cr√©dit 3", 0.0, 1.0, 0.6, step=0.01)
            
            st.markdown("#### üìà Historique")
            payment_history = st.slider("R√©gularit√© paiements", 0.0, 1.0, 0.9, step=0.05)
            st.caption("1.0 = Toujours ponctuel")
        
        submitted = st.form_submit_button("üéØ Analyser la Demande", type="primary", use_container_width=True)
    
    if submitted:
        if not api_ok:
            st.error("üîå API non disponible")
        else:
            data = {
                "EXT_SOURCE_2": ext2,
                "EXT_SOURCE_3": ext3,
                "AMT_GOODS_PRICE": goods_price,
                "CODE_GENDER": gender,
                "EXT_SOURCE_1": ext1,
                "AMT_ANNUITY": annuity,
                "AMT_CREDIT": credit_amount,
                "DAYS_BIRTH": -age * 365,
                "INST_PAYMENT_PERC_mean": payment_history,
                "NAME_EDUCATION_TYPE": education
            }
            
            try:
                response = requests.post(f"{API_URL}/predict/demo", json=data, timeout=10)
                if response.status_code == 200:
                    result = response.json()
                    display_banker_explanation(data, result)
                else:
                    st.error(f"‚ùå Erreur: {response.text}")
            except Exception as e:
                st.error(f"‚ö†Ô∏è Probl√®me: {str(e)}")

# Footer
st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; padding: 1rem;'>
    <strong>üè¶ Pr√™t √† D√©penser</strong> - Mod√®le LightGBM Champion (Seuil: 9%)<br>
    <em>Interface banquier avec explications d√©taill√©es</em>
</div>
""", unsafe_allow_html=True)